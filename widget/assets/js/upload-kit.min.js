!function($){jQuery.fn.yiiUploadKit=function(options){var $input=this,$container=$input.parent("div"),$files=$("<ul>",{"class":"files"}).insertBefore($input),$emptyInput=$container.find(".empty-value"),methods={init:function(){options.multiple&&($input.attr("multiple",!0),$input.attr("name",$input.attr("name")+"[]")),$container.addClass("upload-kit"),options.sortable&&$files.sortable({placeholder:"upload-kit-item sortable-placeholder",tolerance:"pointer",forcePlaceholderSize:!0,update:function(){methods.updateOrder()}}),$input.wrapAll($('<li class="upload-kit-input"></div>')).after($('<span class="glyphicon glyphicon-plus-sign add"></span>')).after($('<span class="glyphicon glyphicon-circle-arrow-down drag"></span>')).after($("<span/>",{"data-toggle":"popover","class":"glyphicon glyphicon-exclamation-sign error-popover"})).after('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></li>'),$files.on("click",".upload-kit-item .remove",methods.removeItem),methods.checkInputVisibility(),methods.fileuploadInit(),methods.dragInit(),!options.acceptFileTypes||options.acceptFileTypes instanceof RegExp||(options.acceptFileTypes=new RegExp(eval(options.acceptFileTypes)))},fileuploadInit:function(){var e=$input.fileupload({name:options.name||"file",url:options.url,dropZone:$input.parents(".upload-kit-input"),dataType:"json",singleFileUploads:!1,multiple:options.multiple,maxNumberOfFiles:options.maxNumberOfFiles,maxFileSize:options.maxFileSize,acceptFileTypes:options.acceptFileTypes,minFileSize:options.minFileSize,messages:options.messages,process:!0,getNumberOfFiles:methods.getNumberOfFiles,start:function(e,t){"yii"==options.errorHandler&&$container.parents("form").yiiActiveForm("updateAttribute",$emptyInput.attr("id"),""),$container.find(".upload-kit-input").removeClass("error").addClass("in-progress"),$input.trigger("start"),void 0!==options.start&&options.start(e,t)},processfail:function(e,t){t.files.error&&methods.showError(t.files[0].error)},progressall:function(e,t){var i=parseInt(t.loaded/t.total*100,10);$container.find(".progress-bar").attr("aria-valuenow",i).css("width",i+"%").text(i+"%")},done:function(e,t){$.each(t.result.files,function(e,t){if(t.error)methods.showError(t.errors);else{var i=methods.createItem(t);i.appendTo($files)}}),methods.handleEmptyValue(),methods.checkInputVisibility(),$input.trigger("done"),void 0!==options.done&&options.done(e,t)},fail:function(e,t){methods.showError(t.errorThrown),void 0!==options.fail&&options.fail(e,t)},always:function(e,t){$container.find(".upload-kit-input").removeClass("in-progress"),$input.trigger("always"),void 0!==options.always&&options.always(e,t)}});options.files&&(options.files.sort(function(e,t){return parseInt(e.order)-parseInt(t.order)}),e.fileupload("option","done").call(e,$.Event("done"),{result:{files:options.files}}),methods.handleEmptyValue(),methods.checkInputVisibility())},dragInit:function(){$(document).on("dragover",function(){$(".upload-kit-input").addClass("drag-highlight")}),$(document).on("dragleave drop",function(){$(".upload-kit-input").removeClass("drag-highlight")})},showError:function(e){"yii"==options.errorHandler?$container.parents("form").yiiActiveForm("updateAttribute",$emptyInput.attr("id"),[e]):$.fn.popover&&$container.find(".error-popover").attr("data-content",e).popover({html:!0,trigger:"hover"}),$container.find(".upload-kit-input").addClass("error")},removeItem:function(e){var t=$(this),i=t.data("url");i&&$.ajax({url:i,type:"DELETE"}),t.parents(".upload-kit-item").remove(),methods.handleEmptyValue(),methods.checkInputVisibility()},createItem:function(e){var t=options.name,i=methods.getNewItemIndex();options.multiple&&(t+="["+i+"]");var n=$("<li>",{"class":"upload-kit-item done",value:i}).append($("<input/>",{name:t+"["+options.pathAttributeName+"]",value:e[options.pathAttribute],type:"hidden"})).append($("<input/>",{name:t+"[name]",value:e.name,type:"hidden"})).append($("<input/>",{name:t+"[size]",value:e.size,type:"hidden"})).append($("<input/>",{name:t+"[type]",value:e.type,type:"hidden"})).append($("<input/>",{name:t+"[order]",value:e.order,type:"hidden","data-role":"order"})).append($("<input/>",{name:t+"["+options.baseUrlAttributeName+"]",value:e[options.baseUrlAttribute],type:"hidden"})).append($("<span/>",{"class":"name",title:e.name,text:options.showPreviewFilename?e.name:null})).append($("<span/>",{"class":"glyphicon glyphicon-remove-circle remove","data-url":e.delete_url}));return e.type&&e.type.search(/image\/.*/g)===-1||!options.previewImage?(n.removeClass("image").addClass("not-image"),n.css("backgroundImage",""),n.find("span.name").text(e.name)):(n.removeClass("not-image").addClass("image"),n.prepend($("<img/>",{src:e[options.baseUrlAttribute]+"/"+e[options.pathAttribute]})),n.find("span.type").text("")),n},checkInputVisibility:function(){var e=$container.find(".upload-kit-input");options.maxNumberOfFiles&&methods.getNumberOfFiles()>=options.maxNumberOfFiles?e.hide():e.show()},handleEmptyValue:function(){methods.getNumberOfFiles()>0?$emptyInput.val(methods.getNumberOfFiles()):$emptyInput.removeAttr("value")},getNumberOfFiles:function(){return $container.find(".files .upload-kit-item").length},getNewItemIndex:function(){var e=[];return $container.find(".files .upload-kit-item").each(function(t,i){e.push(t)}),e.length?Math.max.apply(Math,e)+1:0},updateOrder:function(){$files.find(".upload-kit-item").each(function(e,t){$(t).find("input[data-role=order]").val(e)})}};return methods.init.apply(this),this}}(jQuery);